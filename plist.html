<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1, user-scalable=no"">
<title>IPA → manifest.plist (OTA)</title>
<style>
body { margin:0; font-family: system-ui, -apple-system, sans-serif; background:#f5f6fa; color:#111; }
.container { max-width: 480px; margin:auto; padding:16px; }
h2 { text-align:center; margin-bottom:16px; }
.tabs { display:flex; margin-bottom:12px; border-radius:8px; overflow:hidden; }
.tab-btn { flex:1; padding:10px; border:none; cursor:pointer; font-weight:600; background:#eee; }
.tab-btn.active { background:#0b84ff; color:#fff; }
.card { background:#fff; padding:12px; border-radius:10px; margin-bottom:12px; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
.input, .input-file, .btn { width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; margin-bottom:8px; }
.input-file { padding:6px; }
.btn { border:none; background:#0b84ff; color:#fff; font-weight:600; cursor:pointer; }
.btn.secondary { background:#444; }
.status { padding:10px; border-radius:8px; background:#f0f4ff; margin-top:6px; white-space:pre-line; }
.status.error { background:#ffe6e6; color:#d9534f; border:1px solid #f5c6cb; }
.status.ok { background:#e6ffe6; color:#28a745; border:1px solid #c3e6cb; }
@media (max-width:420px){ .tabs { flex-direction:column; } }
pre { white-space:wrap; word-break:break-all; }
</style>
</head>
<body>
<div class="container">
<h2>IPA → manifest.plist (OTA)</h2>
<script src="https://altstudio.app/js/app-info-parser.min.js"></script>

<div class="tabs">
  <button id="tabUploadBtn" class="tab-btn" onclick="switchTab('upload')">Upload IPA</button>
  <button id="tabUrlBtn" class="tab-btn active" onclick="switchTab('url')">Dán link IPA</button>
</div>

<!-- Upload -->
<div id="tabUpload" class="card" style="display:none">
  <input type="file" id="fileInput" class="input-file" accept=".ipa">
  <input type="url" id="uploadUrlInput" class="input" placeholder="https://yourdomain.com/app.ipa">
  <div class="status" id="uploadStatus" style="display:none"></div>
</div>

<!-- URL -->
<div id="tabUrl" class="card">
  <input type="url" id="urlInput" class="input" placeholder="https://example.com/app.ipa">
  <button class="btn" id="fetchBtn">Tải và tạo manifest</button>
  <div class="status" id="urlStatus" style="display:none"></div>
</div>

<!-- Info Form -->
<div class="card">
  <label>App Name</label>
  <input type="text" id="appName" class="input" placeholder="Tên ứng dụng">

  <label>Tên file *.plist</label>
  <input type="text" id="plistName" class="input" value="manifest.plist">

  <button class="btn" onclick="generatePlist()">Tạo manifest.plist</button>
  <div class="status" id="plistStatus" style="display:none"></div>
</div>

<!-- Download -->
<div id="downloadCard" class="card" style="display:none">
  <button class="btn" onclick="downloadPlist()">Tải *.plist</button>
  <button class="btn secondary" onclick="copyManifest()">Copy nội dung manifest</button>
  <div style="margin-top:8px;">
    <div>Link OTA gợi ý:</div>
    <pre id="otaLink" style="background:#f3f7ff;padding:6px;border-radius:6px;"></pre>
  </div>
</div>

<script>
let lastManifest = '';
let ipaMeta = { bundleId:'', version:'', icon:null, ipaUrl:'' };

function switchTab(name){
  document.getElementById('tabUpload').style.display = name==='upload' ? '' : 'none';
  document.getElementById('tabUrl').style.display = name==='url' ? '' : 'none';
  document.getElementById('tabUploadBtn').classList.toggle('active', name==='upload');
  document.getElementById('tabUrlBtn').classList.toggle('active', name==='url');
  hideStatus();
}

function hideStatus(){
  ['uploadStatus','urlStatus','plistStatus'].forEach(id=>{
    const el=document.getElementById(id);
    if(el){ el.style.display='none'; el.className='status'; el.textContent=''; }
  });
}

function setOk(id,text){ const el=document.getElementById(id); el.style.display='block'; el.className='status ok'; el.textContent=text; }
function setErr(id,text){ const el=document.getElementById(id); el.style.display='block'; el.className='status error'; el.textContent=text; }
async function readIpa(file, overrideIpaUrl){
  try {
    const parser = new window.AppInfoParser(file);
    const info = await parser.parse();
    ipaMeta.bundleId = info.CFBundleIdentifier || '';
    ipaMeta.version  = info.CFBundleShortVersionString || '';
    ipaMeta.icon     = info.icon || null;
    ipaMeta.ipaUrl   = overrideIpaUrl || ipaMeta.ipaUrl;

    document.getElementById('appName').value = info.CFBundleDisplayName || info.CFBundleName || '';
    setOk('uploadStatus', `✅ Đã đọc IPA: ${file.name}\nBundle: ${ipaMeta.bundleId}\nVersion: ${ipaMeta.version}`);
    autoGenerateIfReady();
  } catch(e){ 
    console.error(e); 
    setErr('uploadStatus','❌ File IPA không hợp lệ.'); 
  }
}

function autoGenerateIfReady(){
  const name=document.getElementById('appName').value.trim();
  if(ipaMeta.bundleId && ipaMeta.version && name && ipaMeta.ipaUrl){ generatePlist(); }
}

function generatePlist(){
  hideStatus();
  const name=document.getElementById('appName').value.trim();
  const plistFileName=document.getElementById('plistName').value.trim()||'manifest.plist';
  if(!ipaMeta.bundleId||!ipaMeta.version||!name||!ipaMeta.ipaUrl){ 
    setErr('plistStatus','❌ Thiếu dữ liệu từ IPA hoặc URL.'); 
    return; 
  }

  const plistText=`<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>items</key>
  <array>
    <dict>
      <key>assets</key>
      <array>
        <dict>
          <key>kind</key>
          <string>software-package</string>
          <key>url</key>
          <string>${ipaMeta.ipaUrl}</string>
        </dict>
        ${ipaMeta.icon ? `
        <dict>
          <key>kind</key>
          <string>display-image</string>
          <key>needs-shine</key>
          <true/>
          <key>url</key>
          <string>${ipaMeta.icon}</string>
        </dict>` : ''}
      </array>
      <key>metadata</key>
      <dict>
        <key>bundle-identifier</key>
        <string>${ipaMeta.bundleId}</string>
        <key>bundle-version</key>
        <string>${ipaMeta.version}</string>
        <key>kind</key>
        <string>software</string>
        <key>title</key>
        <string>${name}</string>
      </dict>
    </dict>
  </array>
</dict>
</plist>`;

  lastManifest=plistText;
  setOk('plistStatus','✅ Manifest.plist đã tạo.');
  document.getElementById('downloadCard').style.display='';
  document.getElementById('otaLink').textContent=`itms-services://?action=download-manifest&url=https://yourdomain.com/${plistFileName}`;
}

function downloadPlist(){
  if(!lastManifest){ alert('Chưa tạo manifest'); return; }
  const plistFileName=document.getElementById('plistName').value.trim()||'manifest.plist';
  const blob=new Blob([lastManifest],{type:'text/xml'});
  const a=document.createElement('a'); 
  a.href=URL.createObjectURL(blob); 
  a.download=plistFileName; 
  a.click();
}

function copyManifest(){
  if(!lastManifest){ alert('Chưa tạo manifest'); return; }
  navigator.clipboard.writeText(lastManifest).then(()=> alert('Đã copy nội dung manifest vào clipboard.'));
}

// Sự kiện: Upload file
document.getElementById('fileInput').addEventListener('change', async (e) => {
  hideStatus();
  const file = e.target.files && e.target.files[0];
  if(!file){
    setErr('uploadStatus','❌ Chưa chọn file IPA.');
    return;
  }
  
  const fileNameWithoutIpa = file.name.replace(/\.ipa$/i, '');
  document.getElementById('plistName').value =fileNameWithoutIpa + '.plist'
  ipaMeta.ipaUrl=document.getElementById('uploadUrlInput').value.trim();
  await readIpa(file, ipaMeta.ipaUrl);
});


// Sự kiện: Dán URL và tải/parse
document.getElementById('fetchBtn').addEventListener('click', async () => {
  hideStatus();
  const url = document.getElementById('urlInput').value.trim();
  if(!url){
    setErr('urlStatus','❌ Vui lòng nhập URL IPA.');
    return;
  }
  ipaMeta.ipaUrl=url; // lưu URL để dùng luôn
  try {
    setOk('urlStatus', '⏳ Đang tải file IPA...');
    const res = await fetch(url, { cache: 'no-store' });
    if(!res.ok) throw new Error('Network error');
    const blob = await res.blob();
    const file = new File([blob], 'remote.ipa', { type: blob.type || 'application/octet-stream', lastModified: Date.now() });
    await readIpa(file,url);
    setOk('urlStatus', '✅ Đã tải và đọc IPA từ URL.');
  } catch (err) {
    console.error(err);
    // fallback: chuyển sang tab upload, giữ nguyên URL
    setErr('urlStatus','❌ Không thể tải IPA từ URL. Vui lòng upload file IPA.');
    switchTab('upload');
    document.getElementById('uploadUrlInput').value=url;
    ipaMeta.ipaUrl=url;
  }
});
</script>
</div>
</body>
</html>
