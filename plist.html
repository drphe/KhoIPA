<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>IPA ‚Üí Manifest Generator</title>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
.tab { display: flex; border-bottom: 1px solid #ccc; margin-bottom: 10px; }
.tab button {
  flex: 1; padding: 10px; cursor: pointer; background: #eee; border: none;
}
.tab button.active { background: #ddd; font-weight: bold; }

#uploadTab, #urlTab { display: none; }

.box { padding: 15px; border: 1px solid #ddd; margin-bottom: 20px; border-radius: 6px; }
.status { padding: 10px; background: #f7f7f7; border-radius: 6px; margin-top: 10px; white-space: pre-line; }
.hidden { display: none; }

button {
  padding: 10px 15px;
  background: #007bff;
  border: none;
  color: #fff;
  border-radius: 5px;
  cursor: pointer;
}
button:disabled { background: #999; }
input[type=text] { width: 100%; padding: 8px; }
</style>
</head>

<body>
<h2>IPA ‚Üí Manifest.plist Generator</h2>

<!-- Tabs -->
<div class="tab">
  <button id="tabBtn1" class="active" onclick="openTab('uploadTab', this)">Upload IPA</button>
  <button id="tabBtn2" onclick="openTab('urlTab', this)">D√°n link IPA</button>
</div>

<!-- Upload tab -->
<div id="uploadTab">
  <div class="box">
    <input type="file" id="ipaFile" accept=".ipa">
    <button onclick="readIPAFile()">ƒê·ªçc file IPA</button>
    <div id="uploadStatus" class="status hidden"></div>
  </div>
</div>

<!-- URL tab -->
<div id="urlTab">
  <div class="box">
    <input type="text" id="ipaUrl" placeholder="D√°n link .ipa (HTTPS)">
    <button onclick="readIPAFromURL()">ƒê·ªçc IPA t·ª´ link</button>
    <div id="urlStatus" class="status hidden"></div>
  </div>
</div>

<!-- Output -->
<div id="infoBox" class="box hidden">
  <h3>Th√¥ng tin IPA</h3>
  <div id="ipaInfo"></div>
</div>

<div id="plistBox" class="box hidden">
  <button onclick="downloadPlist()">T·∫£i xu·ªëng manifest.plist</button>
  <div id="otaLink" class="status"></div>
</div>

<script>

/* ------------------------- TAB SWITCH -------------------------- */
function openTab(tabId, btn) {
  document.getElementById("uploadTab").style.display = "none";
  document.getElementById("urlTab").style.display = "none";
  document.querySelectorAll(".tab button").forEach(b => b.classList.remove("active"));

  document.getElementById(tabId).style.display = "block";
  btn.classList.add("active");
}

/* ----------------------- GLOBAL APP INFO ----------------------- */
let appData = {
  ipaUrl: "",
  bundleId: "",
  version: "",
  title: ""
};


/* ---------------------- READ IPA (UPLOAD) ---------------------- */
async function readIPAFile() {
  const file = document.getElementById("ipaFile").files[0];
  const status = document.getElementById("uploadStatus");
  status.classList.remove("hidden");

  if (!file) return status.textContent = "‚ùå Ch∆∞a ch·ªçn file IPA.";

  status.textContent = "üì¶ ƒêang ƒë·ªçc file IPA...";
  try {
    const arrayBuf = await file.arrayBuffer();
    await parseIPA(arrayBuf, "upload");
  } catch (e) {
    status.textContent = "‚ùå L·ªói ƒë·ªçc file IPA:\n" + e.message;
  }
}


/* ---------------------- READ IPA (URL) ------------------------- */
async function readIPAFromURL() {
  const url = document.getElementById("ipaUrl").value.trim();
  const status = document.getElementById("urlStatus");
  status.classList.remove("hidden");

  if (!url.startsWith("http")) {
    return status.textContent = "‚ùå Link IPA ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng http/https.";
  }

  status.textContent = "üåê ƒêang t·∫£i file IPA t·ª´ link...";

  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error("Server tr·∫£ l·ªói HTTP " + res.status);

    const buf = await res.arrayBuffer();
    await parseIPA(buf, "url", url);

  } catch (e) {
    status.textContent = "‚ùå L·ªói t·∫£i IPA:\n" + e.message;
  }
}


/* ------------------------- PARSE IPA --------------------------- */
async function parseIPA(arrayBuf, mode, url="") {
  const zip = await JSZip.loadAsync(arrayBuf);

  // T√¨m ƒë∆∞·ªùng d·∫´n Info.plist
  const plistPath = Object.keys(zip.files).find(p => p.includes("Info.plist"));
  if (!plistPath) throw new Error("Kh√¥ng t√¨m th·∫•y Info.plist trong IPA.");

  // ƒê·ªçc Info.plist
  const plistText = await zip.files[plistPath].async("string");

  // Parse plist (d·∫°ng XML)
  let parser = new DOMParser();
  let xml = parser.parseFromString(plistText, "text/xml");

  function get(key) {
    return xml.querySelector(`key:contains("${key}") + string`)?.textContent || "";
  }

  const bundleId = get("CFBundleIdentifier");
  const version = get("CFBundleVersion") || get("CFBundleShortVersionString");
  const title = get("CFBundleName") || get("CFBundleDisplayName");

  if (!bundleId) throw new Error("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c Bundle ID.");

  // L∆∞u d·ªØ li·ªáu
  appData.bundleId = bundleId;
  appData.version = version || "1.0";
  appData.title = title || "Unnamed App";
  appData.ipaUrl = mode === "url" ? url : "(ch∆∞a c√≥ link, b·∫°n t·ª± up IPA l√™n host tr∆∞·ªõc)";

  // Giao di·ªán
  document.getElementById("infoBox").classList.remove("hidden");
  document.getElementById("plistBox").classList.remove("hidden");

  document.getElementById("ipaInfo").innerHTML = `
    üì¶ <b>T√™n app:</b> ${appData.title}<br>
    üÜî <b>Bundle ID:</b> ${appData.bundleId}<br>
    üî¢ <b>Version:</b> ${appData.version}<br>
    üîó <b>IPA URL:</b> ${appData.ipaUrl}
  `;

  document.getElementById("otaLink").textContent =
    "Sau khi t·∫£i plist, h√£y upload l√™n host v√† d√πng link:\n\n" +
    `itms-services://?action=download-manifest&url=https://yourdomain.com/manifest.plist`;
}


/* ----------------------- DOWNLOAD PLIST ------------------------ */
function downloadPlist() {
  if (!appData.bundleId) return alert("Ch∆∞a c√≥ d·ªØ li·ªáu IPA.");

  const plist = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>items</key>
  <array>
    <dict>
      <key>assets</key>
      <array>
        <dict>
          <key>kind</key>
          <string>software-package</string>
          <key>url</key>
          <string>${appData.ipaUrl}</string>
        </dict>
      </array>
      <key>metadata</key>
      <dict>
        <key>bundle-identifier</key>
        <string>${appData.bundleId}</string>
        <key>bundle-version</key>
        <string>${appData.version}</string>
        <key>kind</key>
        <string>software</string>
        <key>title</key>
        <string>${appData.title}</string>
      </dict>
    </dict>
  </array>
</dict>
</plist>`;

  const blob = new Blob([plist], { type: "text/xml" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "manifest.plist";
  a.click();
}

</script>
</body>
</html>