<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>Tạo mobileconfig bằng JS</title>
</head>
<body>
  <h3>Tạo .mobileconfig bằng JS</h3>
  <label>URL (ví dụ esign://... hoặc https://...):</label><br>
  <input id="url" style="width:90%" value="https://example.com/open-me.html"><br>
  <label>Tên hiển thị (Label):</label><br>
  <input id="label" style="width:90%" value="Open in Safari"><br>
  <label>Icon PNG (tuỳ chọn, phải CORS-allow):</label><br>
  <input id="iconUrl" style="width:90%" placeholder="https://.../icon.png"><br><br>

  <button id="make">Tạo & Tải .mobileconfig</button>
  <button id="open">Tạo & Mở (thử cài)</button>

<script>
// Utility: tạo UUID v4
function uuidv4() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
    const r = (crypto.getRandomValues(new Uint8Array(1))[0] & 15) >> (c === 'x' ? 0 : 0);
    const v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  }).toUpperCase();
}

// Lấy icon và trả về base64 string (hoặc null nếu ko cung cấp)
async function fetchIconAsBase64(iconUrl) {
  if (!iconUrl) return null;
  try {
    const res = await fetch(iconUrl, {mode: 'cors'});
    if (!res.ok) throw new Error('Không tải được icon');
    const blob = await res.blob();
    // đọc Blob thành base64
    return await new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        // reader.result là "data:<type>;base64,AAAA..."
        const dataUrl = String(reader.result);
        // Lấy phần base64 thuần túy:
        const comma = dataUrl.indexOf(',');
        resolve(dataUrl.slice(comma + 1));
      };
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  } catch (e) {
    console.warn('fetchIconAsBase64 lỗi:', e);
    return null;
  }
}

// Tạo nội dung .mobileconfig (string). iconBase64 là chuỗi base64 thuần túy (không có tiền tố data:)
function buildMobileconfigXml({targetUrl, displayLabel = 'WebClip', iconBase64 = null}) {
  const payloadUUID = uuidv4();
  const topUUID = uuidv4();
  const iconBlock = iconBase64 ? `<key>Icon</key><data>\n${iconBase64}\n</data>` : '';
  // Nếu URL là custom-scheme (esign://...), WebClip vẫn lưu URL đó.
  return `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
  "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>PayloadContent</key>
  <array>
    <dict>
      <key>FullScreen</key><true/>
      <key>IsRemovable</key><true/>
      <key>Label</key>
      <string>${escapeXml(displayLabel)}</string>
      <key>PayloadDescription</key>
      <string>WebClip - shortcut created by site</string>
      <key>PayloadDisplayName</key>
      <string>WebClip</string>
      <key>PayloadIdentifier</key>
      <string>com.example.webclip.${payloadUUID}</string>
      <key>PayloadType</key>
      <string>com.apple.webClip.managed</string>
      <key>PayloadUUID</key>
      <string>${payloadUUID}</string>
      <key>PayloadVersion</key>
      <integer>1</integer>
      <key>Precomposed</key><true/>
      <key>URL</key>
      <string>${escapeXml(targetUrl)}</string>
      ${iconBlock}
    </dict>
  </array>
  <key>PayloadDisplayName</key>
  <string>${escapeXml(displayLabel)}</string>
  <key>PayloadIdentifier</key>
  <string>com.example.webclip.top.${topUUID}</string>
  <key>PayloadRemovalDisallowed</key><false/>
  <key>PayloadType</key>
  <string>Configuration</string>
  <key>PayloadUUID</key>
  <string>${topUUID}</string>
  <key>PayloadVersion</key>
  <integer>1</integer>
</dict>
</plist>`;
}

// Escape XML special chars
function escapeXml(unsafe) {
  return String(unsafe)
    .replace(/&/g, '&amp;')
    .replace(/"/g, '&quot;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}

// Tạo Blob và trả về objectURL
function makeMobileconfigBlobUrl(xmlString) {
  // MIME type hợp lý cho mobileconfig
  const blob = new Blob([xmlString], {type: 'application/x-apple-aspen-config'});
  return URL.createObjectURL(blob);
}

// Tải file .mobileconfig xuống
async function downloadBlobUrl(url, filename = 'webclip.mobileconfig') {
  
    await navigator.clipboard.writeText(url);
    alert("✅ Đã sao chép vào clipboard!");
  
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

// Thử mở objectURL trực tiếp (ghì window.location) để Safari có thể show cài đặt
function openBlobUrl(url) {
  // Mở trong tab mới, hoặc thay window.location để navigation
  window.location.href = url; // thử điều hướng tới objectURL
}

// Nút xử lý
document.getElementById('make').addEventListener('click', async () => {
  const targetUrl = document.getElementById('url').value.trim();
  const label = document.getElementById('label').value.trim() || 'WebClip';
  const iconUrl = document.getElementById('iconUrl').value.trim();
  const iconBase64 = await fetchIconAsBase64(iconUrl);
  const xml = buildMobileconfigXml({targetUrl, displayLabel: label, iconBase64});
  const objUrl = makeMobileconfigBlobUrl(xml);
  downloadBlobUrl(objUrl, `${label.replace(/\s+/g,'_')}.mobileconfig`);
  // giải phóng sau 30s
  setTimeout(() => URL.revokeObjectURL(objUrl), 30000);
});

document.getElementById('open').addEventListener('click', async () => {
  const targetUrl = document.getElementById('url').value.trim();
  const label = document.getElementById('label').value.trim() || 'WebClip';
  const iconUrl = document.getElementById('iconUrl').value.trim();
  const iconBase64 = await fetchIconAsBase64(iconUrl);
  const xml = buildMobileconfigXml({targetUrl, displayLabel: label, iconBase64});
  const objUrl = makeMobileconfigBlobUrl(xml);
  // Thử điều hướng tới objectURL để iOS hiển thị dialogue cài profile
  openBlobUrl(objUrl);
  // Nếu không hoạt động, hãy nhắc user tải file rồi mở từ Files app / Mail
  setTimeout(() => URL.revokeObjectURL(objUrl), 60000);
});
</script>
</body>
</html>